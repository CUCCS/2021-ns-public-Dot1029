# 第十一章 常见蜜罐体验和探索

## 一、实验环境

Attacker-kali

- IP:10.0.2.7

Victim-kali-1

- IP:10.0.2.6

# 二、实验目的

1、了解蜜罐的分类和基本原理

2、了解不同类型蜜罐的适用场合

3、掌握常见蜜罐的搭建和使用

## 三、实验要求

1、记录蜜罐的详细搭建过程

2、使用`nmap`扫描搭建好的蜜罐并分析扫描结果，同时分析`nmap` 扫描期间」蜜罐上记录的信息

3、如何辨别当前目标是一个蜜罐，以自己搭建的蜜罐为例说明

4、（可选）总结常见的蜜罐识别和检测方法

5、（可选）基于`canarytokend`搭建密信实验环境进行自由探索性实验

## 四、实验过程

### 前期准备

- 搭建网络拓扑

  ![](IMG\net.png)

- 连通性测试

  `ping 10.0.2.6

  ![](IMG\ping-A-V.png)

  `ping 10.0.2.7`

  ![](IMG\ping-V-A.png)

- 网络测试

  ![](IMG\ping-A.png)

  ![](C:\Users\111\Desktop\chap0x11\IMG\ping-V.png)

### 低交互蜜罐（sshesame）

- `sshesame`：一个假的ssh服务器,让每个人都进入并记录他们的活动日志。一个假的ssh服务器,让每个人都进入并记录他们的活动日志。

  低交互蜜罐只会让攻击者非常**有限地访问**操作系统。“低交互”意味着，对手**无法在任何深度上与您的诱饵系统进行交互**，因为它是一个更加**静态**的环境。低交互蜜罐通常会模仿少量的互联网协议和网络服务，足以欺骗攻击者，而不是更多。通常，大多数企业都会模拟TCP和IP等协议，这使得攻击者可以认为他们正在连接到真实系统而不是蜜罐环境。

- 下载安装sshesame

  ```shell
  $ git clone https://github.com/jaksi/sshesame.git
  $ cd sshesame 
  $ go build
  ```

  【问题】`go`指令包无法安装

  【解决办法】第一个参考资料所提供方法，只需修改go指令包版本即可

- 安装docker

  ```shell
  #安装https协议、CA证书、dirmngr
  apt-get update 
  apt-get install -y apt-transport-https ca-certificates
  apt-get install dirmngr
  
  #添加GPG密钥并添加更新源
  curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/debian/gpg | sudo apt-key add -
  echo 'deb https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/debian/ buster stable' | sudo tee /etc/apt/sources.list.d/docker.list
  
  #系统更新以及安装docker
  apt-get update
  apt install docker-ce
  
  #启动docker服务器
  service docker start
  
  #安装compose
  apt install docker-compose
  
  #docker安装测试
  docker version
  ```

  ![](IMG\docker-install-test.png)

- 配置docker

  ```shell
  $ sudo docker run -it --rm\
    -p 127.0.0.1:2022:2022\
    -v sshesame-data:/data ghcr.io/jaksi/sshesame
  ```

- 启动docker并连接蜜罐

  - 启动docker:`sudo docker run -it --rm\`
  - 连接蜜罐：`ssh -p 2022 127.0.0.1`
  - 一些简单操作

  ![](C:\Users\111\Desktop\chap0x11\IMG\ssh.png)

- 总结：我们可以看到，每一个操作都被记录，包括输入的密码

### 中等交互蜜罐（Cowrie)

- **Cowrie**是一种中等交互的**SSH和Telnet蜜罐**，旨在**记录暴力攻击和攻击者执行的shell交互**。Cowrie还充当SSH和telnet代理，以观察攻击者对另一个系统的行为。同时也是一个模拟的 SSH 服务器。很多攻击者都是 SSH 登录，你可以把这个软件在22端口启动，真正的 SSH 服务器放在另一个端口。当别人以为攻入了服务器，其实进入的是一个虚拟系统，然后会把他们的行为全部记录下来。

  中交互蜜罐是对真正的操作系统的各种行为的模拟，它提供了更多的交互信息，同时也可以从攻击者的行为中获得更多的信息。在这个模拟行为的系统中，蜜罐此时看起来和一个真正的操作系统没有区别，它们甚至是比真正系统还诱人的攻击目标。

- 下载cowire

  ```
  git clone https://github.com/cowrie/docker-cowrie.git
  cd docker-cowrie/   
  docker pull cowrie/cowrie
  docker run -p 2222:2222 cowrie/cowrie
  ```

  ![](C:\Users\111\Desktop\chap0x11\IMG\install-cowire.png)

- nmap 扫描，发现开启的2222端口

- 使用ssh登录，多试几次就能发现，使用root+任意密码都可以登录，非root无法登陆，使用 `ssh -c` 不影响结果。

- TEST

  - `ping` 某个网址

    ![](C:\Users\111\Desktop\chap0x11\IMG\test-ping-xxx.com.png)

  - `sudo apt update`

    ![](C:\Users\111\Desktop\chap0x11\IMG\test-sudoupdate.png)

  - `cat & vim`:发现异常，`vim`显示命令不存在；`cat`问题在于有`a`这个文件，但显示文件不存在

- 查看蜜罐日志

  ```
   # 将日志复制到本地查看
   docker cp a0f7c7db65ab:/cowrie/cowrie-git/var/log/cowrie /home/kali
   # jq带格式高亮查看 
  cat json.txt | jq '.'
  ```

  ![](C:\Users\111\Desktop\chap0x11\IMG\log1.png)
  
  ![](C:\Users\111\Desktop\chap0x11\IMG\log2.png)

## 五、（可选）总结常见的蜜罐识别和检测方法

- 相关文章：
  - [知乎 - 如何判断是不是进入了蜜罐？](https://www.zhihu.com/question/31213254/answer/137153019)
  - [Is it possible to detect a honeypot?](https://security.stackexchange.com/questions/90642/is-it-possible-to-detect-a-honeypot)
  - [How to detect a HoneyPot?](https://www.ethicalhacker.net/forums/topic/how-to-detect-a-honeypot/)
  - [IEEE - Detecting honeypots and other suspicious environments](https://www.ei.ruhr-uni-bochum.de/media/emma/veroeffentlichungen/2012/08/07/Honeypots-IEEE05.pdf)


- 经验和个人感觉
- 常规命令的检测。如本实验所用的 `echo $PATH` 等各种命令，可以上手来一套。这里不展开说明。
- 部分低交互蜜罐，如dionaea，使用nmap请求哪个端口就会开放哪个端口。
- 蜜罐攻陷的成本是非常低的。漏洞过于明显的系统值得被怀疑。
- 给web服务器发送大量http请求，导致web服务器抢占大量计算机资源用来处理请求。这样就会让蜜罐的反应慢下来。
- 检测UML(User Mode Linux)。[论文的III-A](https://www.ei.ruhr-uni-bochum.de/media/emma/veroeffentlichungen/2012/08/07/Honeypots-IEEE05.pdf)阐述了具体操作。
- 数据包时间戳分析、分析低交互蜜罐产生的网络响应来寻找差异、环境不真实导致穿帮。

## 六、参考资料

[go指令安装教程](https://blog.csdn.net/andiao1218/article/details/101192874)

[师姐的实验](https://github.com/CUCCS/2020-ns-public-LyuLumos/tree/ch0x0B)

[docke](https://blog.csdn.net/laughing1997/article/details/84305615)

